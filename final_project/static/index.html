<!DOCTYPE html>
<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.6.0.js"
                integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <script src="/static/cis444.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    </head>
    <body>

        <script>
            function login(){
                $("#login").show();
                $("#signup").hide();
                    
                $.post("/open_api/login",{
                    "username": $('#username').val(), "password":$('#password').val(), "room" : $('#room').val() },
                function(data, textStatus) {
                    //this gets called when browser receives response from server
                    console.log(data.token);
                    //Set global JWT
                    jwt = data.token;
                    //make secure call with the jwt
                    get_msg();
                    }, "json").fail(function(response){
                    console.log("error");
                    console.log(response);
                });
                return false;
                
            }

            function signupform(){
                $("#login").hide();
                $("#signup").show();
                $("#booktable-form").hide();
                $("#booktable-table").hide();
                $("#cart-form").hide();
                $("#cart-table").hide();
            }

            function loginform(){
                $("#login").show();
                $("#signup").hide();
                $("#booktable-form").hide();
                $("#booktable-table").hide();
                $("#cart-form").hide();
                $("#cart-table").hide();
            }

            function signup(){
      
                $.post("/open_api/signup", { 
                    "newuser": $('#newuser').val(), "newpassword": $('#newpassword').val() },
                    function(data, textStatus) {
                            //this gets called when browser receives response from server
                            console.log("In signup");
                        jwt=data.token;
                    }, "json").fail(function(response){
                            console.log("error in signup() index.html");
                            console.log(response);
                    });
                    return false;
            }

            function get_msg(){
                $("#login").hide();
                $("#messages").show();

                console.log("in get_msg()");
               
                secure_get_with_token("/secure_api/chat", 
                    function(data){
                        console.log("got chat"); console.log(data);
                         addMsg(message_input);
                    },
                function(err){ console.log(err) });
            }

            function addMsg(name) {
                console.log("in addMsg before post");
                console.log(name);
                secure_get_with_data("/secure_api/send_msg", 
                {"username":$('#username').val(), "room": $('#room').val(), "message":$(name).val()  },
                    function(data) {
                    console.log("in addMsg(name)");
                    console.log(name);
                    console.log(data)}, function(err){ console.log(err) });

            }
            
        </script>

        <form action="" method="POST">
            <input type="text" class="username" placeholder="User Name"/>
            <input type="text" class="message" placeholder="Messages"/>
            <input type="submit"/>
        </form>

        <div id="login">
            <h1>Welcome!</h1>
                <div id="credbox">
                    <h2>Login</h2>
                    <label>Username:</label><br>
                        <input type="text" id="username" name="username"><br>
                    <label>Password:</label><br>
                        <input type="password"required id="password" name="password" ><br><br>
                    <label>Enter room id:</label>
                        <input type="text" name="room">
                    <button type="button" onclick="return login()">Log In</button>
                
                    <h3>Need an account?</h3>
                <button type="button" onclick="return signupform()">Create Account</button>
                </div>
        </div>

        <div id="signup">
            <div id="credbox">
                <h2>Signup</h2>
                <label>Username:</label><br>
                        <input type="text" id="newuser" name="newuser"><br>
                <label>Password:</label><br>
                        <input type="password"required id="newpassword" name="newpassword" ><br><br>
                <input type="submit" value="Signup" onclick="return signup();">
                <h3>Go back to login page</h3>
                        <button type="button" onclick="return loginform()">Login Page</button>
            </div>
        </div>

        <div id="messages"></div>
        <h1>Welcome to chat room {{ room }}</h1>
        <form id="message_input_form">
            <input type="text" id="message_input" placeholder="Enter your message here">
                <button type="submit">Send</button>
        </form>


    </body>
</html>
